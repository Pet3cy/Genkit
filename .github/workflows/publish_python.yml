# Copyright 2026 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Publish all Python packages to PyPI.
#
# Triggered by pushing a tag like py/v0.7.0 or manually via workflow_dispatch.
# Auth uses PyPI trusted publishing (OIDC) â€” no API tokens needed.

name: Publish Python

on:
  push:
    tags:
      - "py/v*"
  workflow_dispatch:

concurrency:
  group: publish-python-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment:
      name: pypi_github_publishing
    steps:
      - uses: actions/checkout@v5
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
          version: "0.6.6"

      - name: Build and publish packages
        run: |
          set -uo pipefail

          PACKAGES=(
            py/packages/genkit
            py/plugins/anthropic
            py/plugins/compat-oai
            py/plugins/dev-local-vectorstore
            py/plugins/google-cloud
            py/plugins/google-genai
            py/plugins/ollama
            py/plugins/firebase
            py/plugins/flask
            py/plugins/vertex-ai
          )

          FAILED=()
          for pkg in "${PACKAGES[@]}"; do
            echo "::group::$pkg"
            if uv build "$pkg" --out-dir dist/; then
              echo "Build succeeded: $pkg"
            else
              echo "::error::Build failed: $pkg"
              FAILED+=("$pkg")
            fi
            echo "::endgroup::"
          done

          if [ ${#FAILED[@]} -gt 0 ]; then
            echo "::error::Failed packages: ${FAILED[*]}"
          fi

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true
          skip-existing: true

  verify:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Smoke test
        env:
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#py/v}"
          pip install "genkit==${VERSION}"
          python -c "from genkit.ai import Genkit; print('ok')"
